<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="niceRAM"><meta name=description content="niceRAM's Blog"><link rel=prev href=https://niceram.xyz/2021/07/07/20210707_1441/><link rel=canonical href=https://niceram.xyz/2021/11/13/20211113_1255/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>ä½¿ç”¨ Docker æ„å»º Caddy v1 å¹¶è‡ªå®šä¹‰æ’ä»¶ | NiceBlog</title><meta name=title content="ä½¿ç”¨ Docker æ„å»º Caddy v1 å¹¶è‡ªå®šä¹‰æ’ä»¶ | NiceBlog"><link rel=stylesheet href=/css/main.min.css><link rel=stylesheet href=/font/iconfont.css><link rel=stylesheet href=/font-ali/iconfont.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/niceram.xyz\/"},"articleSection":"posts","name":"ä½¿ç”¨ Docker æ„å»º Caddy v1 å¹¶è‡ªå®šä¹‰æ’ä»¶","headline":"ä½¿ç”¨ Docker æ„å»º Caddy v1 å¹¶è‡ªå®šä¹‰æ’ä»¶","description":"Caddy æ˜¯å’Œ NginX ä¸€æ ·çš„ Web Serverï¼Œæ”¯æŒåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ç­‰å¸¸è§åŠŸèƒ½ï¼Œæ›´å‰å®³çš„æ˜¯ Caddy è¿˜æ”¯æŒè‡ªåŠ¨å‘ Let\u0026#39;s Encrypt ç­¾å‘ HTTPS è¯ä¹¦ã€‚ ä¸è¿‡ç”±äº Caddy2 å‘å¸ƒä¸ä¹…ï¼Œå®˜æ–¹ç½‘ç«™å·²ä¸å†æ”¯","inLanguage":"zh-CN","author":"niceRAM","creator":"niceRAM","publisher":"niceRAM","accountablePerson":"niceRAM","copyrightHolder":"niceRAM","copyrightYear":"2021","datePublished":"2021-11-13 12:55:31 \u002b0800 \u002b0800","dateModified":"2021-11-13 12:55:31 \u002b0800 \u002b0800","url":"https:\/\/niceram.xyz\/2021\/11\/13\/20211113_1255\/","wordCount":"1527","keywords":["Docker","CloudFlare","Caddy1","Caddy","NiceBlog"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>>$</span>
<a href=https://niceram.xyz/><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=/posts/ title>ğŸ“šBlog</a>
<a class=menu-item href=/categories/ title>ğŸ“‚Categories</a>
<a class=menu-item href=/tags/ title>ğŸ“ŒTags</a>
<a class=menu-item href=/about/ title>ğŸ’¬About</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://niceram.xyz/>NiceBlog</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=/posts/ title><h3>ğŸ“šBlog</h3><div class=menu-active></div></a><a class=menu-item href=/categories/ title><h3>ğŸ“‚Categories</h3><div class=menu-active></div></a><a class=menu-item href=/tags/ title><h3>ğŸ“ŒTags</h3><div class=menu-active></div></a><a class=menu-item href=/about/ title><h3>ğŸ’¬About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">ä½¿ç”¨ Docker æ„å»º Caddy v1 å¹¶è‡ªå®šä¹‰æ’ä»¶</h1><div class=post-meta>Written by <a itemprop=name href=https://niceram.xyz/ rel=author>niceRAM</a> with â™¥
<span class=post-time>on <time datetime=2021-11-13 itemprop=datePublished>November 13, 2021</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://niceram.xyz/categories/%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/>è™šæ‹ŸåŒ–æŠ€æœ¯,</a></span>
<span class=post-word-count>1527 words</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#å®‰è£…-docker>å®‰è£… Docker</a></li><li><a href=#é•œåƒå‡†å¤‡>é•œåƒå‡†å¤‡</a><ul><li><a href=#å…‹éš†ä»“åº“>å…‹éš†ä»“åº“</a></li><li><a href=#æŸ¥æ‰¾ç¬¬ä¸‰æ–¹æ’ä»¶caddy1>æŸ¥æ‰¾ç¬¬ä¸‰æ–¹æ’ä»¶ï¼ˆCaddy1ï¼‰</a></li><li><a href=#æ·»åŠ ç¬¬ä¸‰æ–¹æ’ä»¶>æ·»åŠ ç¬¬ä¸‰æ–¹æ’ä»¶</a></li><li><a href=#æ„å»ºé•œåƒå¹¶å¯åŠ¨å®¹å™¨>æ„å»ºé•œåƒå¹¶å¯åŠ¨å®¹å™¨</a></li></ul></li></ul></nav></div></div><div class=post-content><p>Caddy æ˜¯å’Œ NginX ä¸€æ ·çš„ Web Serverï¼Œæ”¯æŒåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ç­‰å¸¸è§åŠŸèƒ½ï¼Œæ›´å‰å®³çš„æ˜¯ Caddy è¿˜æ”¯æŒè‡ªåŠ¨å‘
<a href="https://www.google.com/search?q=Let%27s%20Encrypt" target=_blank><i class="iconfont icon-search">Let's Encrypt</i></a>
ç­¾å‘ HTTPS è¯ä¹¦ã€‚</p><p>ä¸è¿‡ç”±äº Caddy2 å‘å¸ƒä¸ä¹…ï¼Œå®˜æ–¹ç½‘ç«™å·²ä¸å†æ”¯æŒ Caddy1 çš„åœ¨çº¿æ„å»ºå’Œæ’ä»¶æ‰“åŒ…äº†ã€‚å‰å‡ å¤©ç ”ç©¶äº†ä¸‹ï¼Œç”±äºä¸æ‡‚ Golangï¼Œå‡ ä¸ªé—®é¢˜æ‹–äº†ä¸å°‘æ—¶é—´ï¼Œæœ€åæ€»ç®—æ˜¯æå®šäº†ï¼Œåœ¨æ­¤è®°å½•ä¸‹æ¥ã€‚</p><hr><h2 id=å®‰è£…-docker>å®‰è£… Docker</h2><p>Caddy æ˜¯ä½¿ç”¨ Golang å¼€å‘æ„å»ºçš„ï¼Œè™½ç„¶å®‰è£… Go å¼€å‘ç¯å¢ƒä¹Ÿè¡Œï¼Œä¸è¿‡ä¸ªäººä¸ä½¿ç”¨ Go è¿›è¡Œå¼€å‘ä½œä¸šçš„è¯ï¼Œå»ºè®®ä½¿ç”¨ Dockerã€‚</p><p>å®‰è£… Docker è¿™ä¸€æ­¥å¿…ç„¶æ˜¯å¿…é¡»çš„ï¼Œä¸è¿‡æœ¬æ–‡ä¸åšè®²è§£ï¼Œå–„ç”¨æœç´¢å¼•æ“æˆ–å®˜æ–¹æ–‡æ¡£ <a href=https://docs.docker.com/get-docker/>Get Docker | Docker Documentation</a> å¾ˆå®¹æ˜“å°±èƒ½è§£å†³ã€‚</p><h2 id=é•œåƒå‡†å¤‡>é•œåƒå‡†å¤‡</h2><p>DockerHub ä¸Šæœç´¢ Caddyï¼Œä½¿ç”¨ç‡æœ€é«˜çš„æ˜¯ <a href=https://hub.docker.com/r/abiosoft/caddy/>abiosoft/caddy - Docker Image | Docker Hub</a>ï¼Œä¸è¿‡æœ¬äººå°è¯•å¤šæ¬¡ï¼Œæ€»æ˜¯ä¼šæ„å»ºå¤±è´¥ï¼Œæ ¹æ® <a href=https://github.com/abiosoft/caddy-docker/issues/248>Docker-Compose Build Failure Â· Issue #248 Â· abiosoft/caddy-docker</a> å¾—çŸ¥ï¼Œä½¿ç”¨ <code>--build-args plugins=xxx</code> æ·»åŠ ç¬¬ä¸‰æ–¹æ’ä»¶æ—¶å¯èƒ½ä¼šä½¿ç”¨ä¸ Caddy1 ä¸å…¼å®¹ç‰ˆæœ¬çš„å…¶ä»–æ’ä»¶ã€‚</p><p><em><strong>Note:</strong> è¯¦ç»†çš„æ²¡æœ‰å†çœ‹ï¼Œæ¨æµ‹æ˜¯æœ‰çš„æ’ä»¶ä½œè€…åœ¨ Caddy2 å‘å¸ƒåä¹Ÿé¡ºåŠ¿æ›´æ–°äº†è‡ªå·±çš„æ’ä»¶å§ï¼Œç„¶åç”±äºä½œè€…çš„é•œåƒæ˜¯ä½¿ç”¨è„šæœ¬çˆ¬å–æ’ä»¶çš„æœ€æ–° moduleï¼Œå°±æ˜¯ Golang é‡Œ import, require é‡Œå†™çš„ç±»ä¼¼ç½‘å€çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°æ„å»º Caddy æ—¶ä½¿ç”¨äº† Caddy2 æ’ä»¶çš„æƒ…å†µ</em></p><p>ä¸è¿‡ï¼Œåœ¨è¯¥ Issue ä¸‹æœ‰å¤§ä½¬æåˆ°ä»–ä¿®æ”¹äº† abiosoft çš„é•œåƒï¼Œå¹¶ä¸”æœ‰äººä½¿ç”¨ä»–ä¿®æ”¹çš„é•œåƒæˆåŠŸæ„å»ºäº†ï¼Œæˆ‘å†³å®šå°è¯•ä¸€ä¸‹â€”â€”ä»ä»“åº“å¼€å§‹æ„å»ºé•œåƒã€‚</p><p>ä»“åº“åœ°å€ï¼š<a href=https://github.com/Yun-Mao/caddy_docker>Yun-Mao/caddy_docker: Caddy_docker</a></p><h3 id=å…‹éš†ä»“åº“>å…‹éš†ä»“åº“</h3><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=ln>1</span>git clone https://github.com/Yun-Mao/caddy_docker.git
</code></pre></div><h3 id=æŸ¥æ‰¾ç¬¬ä¸‰æ–¹æ’ä»¶caddy1>æŸ¥æ‰¾ç¬¬ä¸‰æ–¹æ’ä»¶ï¼ˆCaddy1ï¼‰</h3><p>Yun-Mao/caddy_docker æ˜¯åŸºäº abiosoft/caddy ä¿®æ”¹ï¼Œä¸ä½¿ç”¨ <code>--build-args</code> è€Œæ˜¯ç›´æ¥åœ¨ <code>build.sh</code> ä¸­æŒ‡å®šç¬¬ä¸‰æ–¹æ’ä»¶çš„ GoPath</p><p>ç¬¬ä¸‰æ–¹æ’ä»¶æ ¹æ®ä¸ªäººéœ€æ±‚è€Œå®šï¼Œæœ¬æ–‡ä¸­æ·»åŠ çš„ç¬¬ä¸‰æ–¹æ’ä»¶æ˜¯ï¼š tls.dns.cloudflare, http.forwardproxy, http.filter, http.ipfilterã€‚è¿˜æœ‰å‡ ä¸ªæ˜¯ä»“åº“åŸæœ¬å°±æœ‰ï¼šcaddy-cache, caddy-minify, caddy-expires, caddy-realipã€‚å¦‚æœè¿˜éœ€è¦åˆ«çš„æ’ä»¶ï¼Œè¯·å–„ç”¨æœç´¢å¼•æ“+githubï¼Œç¡®è®¤è‡ªå·±æ‰€éœ€æ’ä»¶çš„ module åã€‚</p><p>ç®€å•æ¥è¯´æ€è·¯å°±æ˜¯ï¼š</p><ol><li>é€šè¿‡æ’ä»¶çš„å…³é”®å­—æ‰¾åˆ°å¯¹åº”çš„ github ä»“åº“</li><li>åœ¨ä»“åº“çš„ tag æ‰¾åˆ°å…¼å®¹ Caddy1 çš„ç‰ˆæœ¬</li><li>åœ¨è¯¥ tag ä¸‹æ‰¾ <code>go.mod</code> æˆ–è€… <code>&lt;æ’ä»¶å>.go</code> åï¼Œç¡®è®¤é‡Œé¢çš„ module åï¼ˆä¸å‡ºæ„å¤–å°±æ˜¯ç¬¬ä¸€è¡Œï¼‰</li></ol><h3 id=æ·»åŠ ç¬¬ä¸‰æ–¹æ’ä»¶>æ·»åŠ ç¬¬ä¸‰æ–¹æ’ä»¶</h3><p>è¿›å…¥ <code>caddy_docker</code> ç›®å½•ï¼Œæ‰“å¼€ <code>builder.sh</code>ï¼Œæ‰¾åˆ° <code>module()</code> å‡½æ•°ï¼Œæ ¹æ®éœ€æ±‚ä¿®æ”¹ã€‚</p><p>æˆ‘æ·»åŠ  <code>tls.dns.cloudflare</code> æ²¡æœ‰åƒ Yun-Mao é‚£æ ·è‡ªå®šä¹‰å‡ ä¸ªå‡½æ•°ï¼Œé‚£äº›å¥½åƒæ˜¯æŒ‡å®š tls æ’ä»¶çš„ email å’Œ apikey çš„ã€‚</p><p>ä¸€å¼€å§‹æˆ‘ä¹Ÿæ˜¯ä½¿ç”¨ <code>github.com/go-acme/lego</code> çš„ cloudflare æ’ä»¶ï¼Œä¿®æ”¹ <code>NewDNSProvider</code> ç­‰å‡½æ•°æ¥æ„å»ºï¼Œ
åæ¥å‘ç°ä½¿ç”¨ <code>github.com/caddyserver/dnsproviders/cloudflare</code> ç›´æ¥æ„å»ºç›®å‰ä¹Ÿæ²¡å‘ç°ä»€ä¹ˆé—®é¢˜ï¼Œä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œç´¢æ€§å°±åˆ æ‰äº†å¤šä½™çš„éƒ¨åˆ†ã€‚</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=ln> 1</span>module<span class=o>()</span> <span class=o>{</span>
<span class=ln> 2</span>    mkdir -p /caddy
<span class=ln> 3</span>    <span class=nb>cd</span> /caddy <span class=c1># build dir</span>
<span class=ln> 4</span>    cat &gt; go.mod <span class=s>&lt;&lt;EOF
</span><span class=ln> 5</span><span class=s>    module caddy
</span><span class=ln> 6</span><span class=s>
</span><span class=hl><span class=ln> 7</span><span class=s>    go 1.14
</span></span><span class=ln> 8</span><span class=s>
</span><span class=ln> 9</span><span class=s>    require (
</span><span class=ln>10</span><span class=s>        github.com/caddyserver/caddy v1.0.5
</span><span class=hl><span class=ln>11</span><span class=s>        github.com/caddyserver/dnsproviders v0.4.0
</span></span><span class=hl><span class=ln>12</span><span class=s>        github.com/grpc-ecosystem/grpc-gateway v1.16.0
</span></span><span class=hl><span class=ln>13</span><span class=s>        github.com/lucas-clemente/quic-go v0.19.3
</span></span><span class=ln>14</span><span class=s>        github.com/captncraig/caddy-realip v0.0.0-20190710144553-6df827e22ab8
</span><span class=ln>15</span><span class=s>        github.com/echocat/caddy-filter v0.14.0
</span><span class=ln>16</span><span class=s>        github.com/epicagency/caddy-expires v1.1.1
</span><span class=ln>17</span><span class=s>        github.com/hacdias/caddy-minify v1.0.2
</span><span class=ln>18</span><span class=s>        github.com/nicolasazrak/caddy-cache v0.3.4
</span><span class=ln>19</span><span class=s>        github.com/pquerna/cachecontrol v0.0.0-20180517163645-1555304b9b35 // indirect
</span><span class=ln>20</span><span class=s>    )
</span><span class=ln>21</span><span class=s>EOF</span>
<span class=ln>22</span>    <span class=c1># main and telemetry</span>
<span class=ln>23</span>    cat &gt; main.go <span class=s>&lt;&lt;EOF
</span><span class=ln>24</span><span class=s>    package main
</span><span class=ln>25</span><span class=s>
</span><span class=ln>26</span><span class=s>    import (
</span><span class=ln>27</span><span class=s>        &#34;github.com/caddyserver/caddy/caddy/caddymain&#34;
</span><span class=ln>28</span><span class=s>
</span><span class=hl><span class=ln>29</span><span class=s>        _ &#34;github.com/caddyserver/dnsproviders/cloudflare&#34;
</span></span><span class=hl><span class=ln>30</span><span class=s>        _ &#34;github.com/caddyserver/forwardproxy&#34;                 //http.forwardproxy
</span></span><span class=hl><span class=ln>31</span><span class=s>        _ &#34;github.com/pyed/ipfilter&#34;                            //http.ipfilter
</span></span><span class=ln>32</span><span class=s>        _ &#34;github.com/echocat/caddy-filter&#34;
</span><span class=ln>33</span><span class=s>        _ &#34;github.com/nicolasazrak/caddy-cache&#34;
</span><span class=ln>34</span><span class=s>        _ &#34;github.com/hacdias/caddy-minify&#34;
</span><span class=ln>35</span><span class=s>        _ &#34;github.com/epicagency/caddy-expires&#34;
</span><span class=ln>36</span><span class=s>        _ &#34;github.com/captncraig/caddy-realip&#34;
</span><span class=ln>37</span><span class=s>    )
</span><span class=ln>38</span><span class=s>
</span><span class=ln>39</span><span class=s>    func main() {
</span><span class=ln>40</span><span class=s>        caddymain.E</span>nableTelemetry <span class=o>=</span> <span class=nb>false</span>
<span class=ln>41</span>        caddymain.Run<span class=o>()</span>
<span class=ln>42</span>    <span class=o>}</span>
</code></pre></div><p>éƒ¨åˆ† module ä¾èµ– go1.14ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¿®æ”¹ <code>Dockerfile</code></p><div class=highlight><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=hl><span class=ln> 1</span><span class=k>FROM</span><span class=s> golang:1.14-alpine as builder</span><span class=err>
</span></span><span class=ln> 2</span><span class=err></span><span class=k>RUN</span> apk add --no-cache git gcc musl-dev<span class=err>
</span><span class=ln> 3</span><span class=err></span><span class=k>RUN</span> mkdir /www /caddy<span class=err>
</span><span class=ln> 4</span><span class=err></span><span class=k>COPY</span> builder.sh /usr/bin/builder.sh<span class=err>
</span><span class=ln> 5</span><span class=err></span><span class=k>ARG</span> <span class=nv>version</span><span class=o>=</span><span class=s2>&#34;1.0.5&#34;</span><span class=err>
</span><span class=ln> 6</span><span class=err></span><span class=k>RUN</span> <span class=nv>VERSION</span><span class=o>=</span><span class=si>${</span><span class=nv>version</span><span class=si>}</span> /bin/sh /usr/bin/builder.sh<span class=err>
</span><span class=ln> 7</span><span class=err>
</span><span class=ln> 8</span><span class=err>
</span><span class=ln> 9</span><span class=err></span><span class=k>FROM</span><span class=s> alpine:latest</span><span class=err>
</span><span class=ln>10</span><span class=err>
</span><span class=ln>11</span><span class=err></span><span class=k>ENV</span> <span class=nv>CADDY_VERSION</span><span class=o>=</span><span class=m>1</span>.0.5<span class=err>
</span><span class=ln>12</span><span class=err>
</span><span class=ln>13</span><span class=err></span><span class=k>ENV</span> <span class=nv>CADDYPATH</span><span class=o>=</span>/caddy/certs<span class=err>
</span><span class=ln>14</span><span class=err>
</span><span class=ln>15</span><span class=err></span><span class=k>RUN</span> apk add --no-cache <span class=se>\
</span><span class=ln>16</span><span class=se></span>    ca-certificates <span class=se>\
</span><span class=ln>17</span><span class=se></span>    git <span class=se>\
</span><span class=ln>18</span><span class=se></span>    mailcap <span class=se>\
</span><span class=ln>19</span><span class=se></span>    openssh-client <span class=se>\
</span><span class=ln>20</span><span class=se></span>    tzdata<span class=err>
</span><span class=ln>21</span><span class=err>
</span><span class=ln>22</span><span class=err>
</span><span class=ln>23</span><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /install/caddy /usr/bin/caddy<span class=err>
</span><span class=ln>24</span><span class=err>
</span><span class=ln>25</span><span class=err></span><span class=k>RUN</span> /usr/bin/caddy -version<span class=err>
</span><span class=ln>26</span><span class=err></span><span class=k>RUN</span> /usr/bin/caddy -plugins<span class=err>
</span><span class=ln>27</span><span class=err>
</span><span class=ln>28</span><span class=err></span><span class=k>EXPOSE</span><span class=s> 80 443 2015</span><span class=err>
</span><span class=ln>29</span><span class=err></span><span class=k>VOLUME</span><span class=s> /root/.caddy /www</span><span class=err>
</span><span class=ln>30</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /www</span><span class=err>
</span><span class=ln>31</span><span class=err>
</span><span class=ln>32</span><span class=err></span><span class=k>COPY</span> Caddyfile /caddy/Caddyfile<span class=err>
</span><span class=ln>33</span><span class=err>
</span><span class=ln>34</span><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;caddy&#34;</span><span class=p>,</span><span class=s2>&#34;--conf&#34;</span><span class=p>,</span> <span class=s2>&#34;/caddy/Caddyfile&#34;</span><span class=p>,</span> <span class=s2>&#34;--log&#34;</span><span class=p>,</span> <span class=s2>&#34;stdout&#34;</span><span class=p>,</span> <span class=s2>&#34;--agree&#34;</span><span class=p>]</span><span class=err>
</span></code></pre></div><h3 id=æ„å»ºé•œåƒå¹¶å¯åŠ¨å®¹å™¨>æ„å»ºé•œåƒå¹¶å¯åŠ¨å®¹å™¨</h3><p>å»ºè®®é€šè¿‡ <code>docker-compose</code> æ„å»ºé•œåƒ</p><ol><li>åˆ›å»º docker-compose.yaml</li></ol><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=ln>1</span><span class=nb>cd</span> caddy_docker
<span class=ln>2</span>touch docker-compose.yaml
</code></pre></div><ol start=2><li>ç¼–è¾‘ docker-compose.yaml ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹</li></ol><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=ln> 1</span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span><span class=ln> 2</span><span class=w>
</span><span class=ln> 3</span><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span><span class=ln> 4</span><span class=w>  </span><span class=nt>caddy</span><span class=p>:</span><span class=w>
</span><span class=ln> 5</span><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>caddy</span><span class=w>
</span><span class=ln> 6</span><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span><span class=ln> 7</span><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>./caddy_docker</span><span class=w>
</span><span class=ln> 8</span><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=ln> 9</span><span class=w>        </span><span class=nt>network</span><span class=p>:</span><span class=w> </span><span class=l>host</span><span class=w>
</span><span class=ln>10</span><span class=w>        </span><span class=c># HTTPS_PROXY: </span><span class=w>
</span><span class=ln>11</span><span class=w>        </span><span class=c># NO_PROXY: localhost,127.0.0.1</span><span class=w>
</span><span class=ln>12</span><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span><span class=ln>13</span><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;host&#34;</span><span class=w>
</span><span class=ln>14</span><span class=w>    </span><span class=c># environment:</span><span class=w>
</span><span class=ln>15</span><span class=w>    </span><span class=c>#   CLOUDFLARE_EMAIL: </span><span class=w>
</span><span class=ln>16</span><span class=w>    </span><span class=c>#   CLOUDFLARE_API_KEY: </span><span class=w>
</span><span class=ln>17</span><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=ln>18</span><span class=w>      </span>- <span class=l>./Caddyfile:/caddy/Caddyfile</span><span class=w>
</span><span class=ln>19</span><span class=w>      </span>- <span class=l>./certs:/caddy/certs</span><span class=w>
</span><span class=ln>20</span><span class=w>      </span>- <span class=l>./.caddy:/root/.caddy</span><span class=w>
</span><span class=ln>21</span><span class=w>      </span>- <span class=l>./www:/www/:rw</span><span class=w>
</span></code></pre></div><p>æˆ–ç›´æ¥ä½¿ç”¨ cat</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=ln> 1</span>cat &gt; docker-compose.yaml <span class=s>&lt;&lt;EOF
</span><span class=ln> 2</span><span class=s>version: &#39;3&#39;
</span><span class=ln> 3</span><span class=s>
</span><span class=ln> 4</span><span class=s>services:
</span><span class=ln> 5</span><span class=s>  caddy:
</span><span class=ln> 6</span><span class=s>    container_name: caddy
</span><span class=ln> 7</span><span class=s>    build:
</span><span class=ln> 8</span><span class=s>      context: ./caddy_docker
</span><span class=ln> 9</span><span class=s>      args:
</span><span class=ln>10</span><span class=s>        network: host
</span><span class=ln>11</span><span class=s>        # HTTPS_PROXY: 
</span><span class=ln>12</span><span class=s>        # NO_PROXY: localhost,127.0.0.1
</span><span class=ln>13</span><span class=s>    restart: always
</span><span class=ln>14</span><span class=s>    network_mode: &#34;host&#34;
</span><span class=ln>15</span><span class=s>    # environment:
</span><span class=ln>16</span><span class=s>    #   CLOUDFLARE_EMAIL: 
</span><span class=ln>17</span><span class=s>    #   CLOUDFLARE_API_KEY: 
</span><span class=ln>18</span><span class=s>    volumes:
</span><span class=ln>19</span><span class=s>      - ./Caddyfile:/caddy/Caddyfile
</span><span class=ln>20</span><span class=s>      - ./certs:/caddy/certs
</span><span class=ln>21</span><span class=s>      - ./.caddy:/root/.caddy
</span><span class=ln>22</span><span class=s>      - ./www:/www/:rw
</span><span class=ln>23</span><span class=s>EOF</span>
</code></pre></div><ol start=3><li>æ„å»º</li></ol><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=ln>1</span>docker-compose build --force-rm
</code></pre></div><p><em><strong>Tips:</strong> <code>--force-rm</code> å‚æ•°æ˜¯ä¸ºäº†æ„å»ºç»“æŸè‡ªåŠ¨åˆ é™¤é•œåƒï¼Œæ„å»ºå¤±è´¥çš„åœºæ™¯ä¸‹å·æ‡’å¾ˆæœ‰ç”¨</em></p><ol start=4><li>å¯åŠ¨
æŠŠè‡ªå·±çš„ Caddyfile æ”¾åœ¨å’Œ docker-compose.yaml åŒç›®å½•ä¸‹å°±å¯ä»¥å¯åŠ¨äº†</li></ol><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=ln>1</span>docker-compose up
</code></pre></div><p><em><strong>Note:</strong> ç¬¬ä¸€æ¬¡å¯åŠ¨å»ºè®®ä¸è¦åŠ  <code>-d</code>ï¼Œåœ¨å‰å°å¯ä»¥åŠæ—¶çœ‹åˆ° ssl è¯ä¹¦æ˜¯å¦æˆåŠŸç­¾å‘ï¼ŒæœåŠ¡æ˜¯å¦å·²ç»æ­£å¸¸å¯åŠ¨ï¼Œå¦‚æœæœ‰é—®é¢˜ç›´æ¥ <code>Ctrl+C</code>ã€‚æ­£å¸¸å¯åŠ¨åè¦åˆ‡æ¢è‡³åå°ï¼Œ<code>Ctrl+Z</code> å°±å¯ä»¥äº†ã€‚</em></p><p>å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œ<strong>ä¸€å®šè¦æŠŠå®¹å™¨çš„ <code>/caddy/certs</code> æŒ‚è½½åˆ°å®¿ä¸»æœºä¸Š</strong>ï¼Œè¿™ä¸ªç›®å½•å°±æ˜¯ ssl è¯ä¹¦çš„å­˜å‚¨ç›®å½•ï¼Œå¦‚æœä¸æŒ‚è½½åˆ°å®¿ä¸»æœºä¸Šï¼Œæ¯æ¬¡é‡å¯å®¹å™¨éƒ½è¦é‡æ–°ç­¾å‘è¯ä¹¦ï¼ŒçŸ­æ—¶é—´å†…è¯·æ±‚è¿‡å¤šçš„è¯è‡ªç„¶å°±ä¼šè¢« Let&rsquo;s Encrypt æ‹’ç»è®¿é—®äº†ã€‚</p><p>å¦‚æœéœ€è¦æŠŠå·²ç»æ„å»ºå¥½çš„ caddy ç¨‹åºæ”¾åˆ°å¦ä¸€å°åŒæ¶æ„çš„æœºå™¨ä¸Šè¿è¡Œï¼ŒæŠŠå®¹å™¨é‡Œçš„ <code>/usr/bin/caddy</code> æ‹·è´å‡ºæ¥æˆ–è€…æ„å»ºå®¹å™¨çš„æ—¶å€™æŠŠå®¹å™¨çš„ <code>/install</code> æŒ‚è½½åˆ°å®¿ä¸»æœºä¸Šå°±è¡Œã€‚</p><p>è¦è®°å½•çš„åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå®Œæ•´é¡¹ç›®å·²ä¸Šä¼ åˆ° githubï¼š<a href=https://github.com/niceRAM/caddy_docker>niceRAM/caddy_docker: Caddy_docker</a></p><div class=post-ref><h2 id=å‚è€ƒé“¾æ¥>å‚è€ƒé“¾æ¥</h2><ul><li><a href=https://github.com/abiosoft/caddy-docker>Docker container for Caddy</a>
, abiosoft</li><li><a href=https://github.com/abiosoft/caddy-docker/issues/248#issuecomment-610198138>Docker-Compose Build Failure Â· Issue #248 Â· abiosoft/caddy-docker</a></li><li><a href=https://github.com/Yun-Mao/caddy_docker>Caddy_docker</a>
, Yun-Mao</li></ul></div></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>niceRAM</span></p><p class=copyright-item><span>Link:</span>
<a href=https://niceram.xyz/2021/11/13/20211113_1255/>https://niceram.xyz/2021/11/13/20211113_1255/</a></p><p class="copyright-item lincese">æœ¬æ–‡é‡‡ç”¨<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 4.0 å›½é™…è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯</p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://niceram.xyz/tags/docker/>#Docker</a></span>
<span class=tag><a href=https://niceram.xyz/tags/cloudflare/>#CloudFlare</a></span>
<span class=tag><a href=https://niceram.xyz/tags/caddy1/>#Caddy1</a></span>
<span class=tag><a href=https://niceram.xyz/tags/caddy/>#Caddy</a></span></section><section><a href=javascript:window.history.back();>back</a></span> Â·
<span><a href=https://niceram.xyz/>home</a></span></section></div><div class=post-nav><a href=https://niceram.xyz/2021/07/07/20210707_1441/ class=prev rel=prev title="Angular è·å–åŸç”Ÿ DOM å¯¹è±¡æ—¶å‡ºç° 'undefined'"><i class="iconfont icon-left"></i>&nbsp;Angular è·å–åŸç”Ÿ DOM å¯¹è±¡æ—¶å‡ºç° 'undefined'</a></div><div class=post-social><div class=social-links><style type=text/css>@font-face{font-family:iconfont;src:url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.eot);src:url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.eot?#iefix)format('embedded-opentype'),url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.woff2)format('woff2'),url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.woff)format('woff'),url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.ttf)format('truetype'),url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.svg#iconfont)format('svg')}</style><a href="https://space.bilibili.com/10929768/channel/detail?cid=12977" target=_blank rel="me noopener"><i class="iconfont icon-bilibili"></i></a><a href=https://github.com/niceRAM target=_blank rel="me noopener"><i class="iconfont icon-github"></i></a><a href=https://twitter.com/niceRAM95 target=_blank rel="me noopener"><i class="iconfont icon-twitter"></i></a><a href=mailto:niceniceram@gmail.com rel="me noopener"><i class="iconfont icon-mail01"></i></a></div></div><div class=post-comment><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.bootcss.com/gitalk/1.5.2/gitalk.css><script src=https://cdn.bootcss.com/gitalk/1.5.2/gitalk.min.js></script><script>const gitalk=new Gitalk({clientID:'e2ac76297f1e7ec232f9',clientSecret:'4385d32dd8c6ab5f97856bbe2e04a1e05a237276',repo:'blog-comments',owner:'niceRAM',admin:['niceRAM'],proxy:'https://cors-anywhere-niceblog.herokuapp.com/https://github.com/login/oauth/access_token',id:location.pathname,distractionFreeMode:!1});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('gitalk-container').innerHTML='Gitalk comments not available by default when the website is previewed locally.';return}gitalk.render('gitalk-container')})()</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2018 - 2021</span>
<span class=rotating>ğŸŒ¸</span>
<span class=author itemprop=copyrightHolder><a href=https://niceram.xyz/>niceRAM</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/niceRAM/nicesima target=_blank rel="external nofollow">nicesima</a></span></div></footer><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script><script defer src=/js/vendor_main.min.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script></div></body></html>